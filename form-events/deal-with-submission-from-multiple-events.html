<p>
    <i>
        This article was originaly published on
        <a href="https://knplabs.com/fr/blog/deal-with-form-submission-from-multiple-events-animation-react-redux">
            KNP Labs blog
        </a>.
    </i>
</p>

<blockquote>
    When struggling with a problem, the worst mistake a mathematician can make,
    is to look for a solution into a book.
</blockquote>

<p>
    Although quite provocative, those words by French mathematician Alain Connes
    also sound relevant about handling development problems: just replace
    « book » by « internet ». What’s the underneath idea ? The best way to learn
    something is to be stuck, search, be stuck again and finally ask for help.
    This is why this article tries to focus on conception rather than on code
    (don’t worry, code comes afterwards!).
</p>

<p>
    My teammates and I recently encountered a simple but interesting problem on
    a client project here at KNP, which mainly consists in an administration
    interface for a news & current affairs website. Nothing fancy at first
    sight, editors need to write and edit all kinds of contents (mostly
    articles) and their metadata, for search engine optimization concerns. A
    picture beeing worth a thousand word, here is a little cinematic of what the
    UI/UX looks like for this feature:
</p>

<figure>
    <img src="https://raw.githubusercontent.com/jaljo/articles/master/images/fe_1.png" alt="cinematic-1" />
    <figcaption>
        From the article editor, the user clicks on abutton that will trigger
        the opening of a hidden panel.
    </figcaption>
</figure>

<figure>
    <img src="https://raw.githubusercontent.com/jaljo/articles/master/images/fe_2.png" alt="cinematic-2" />
    <figcaption>
        The panel opens gently, because it's polite.
    </figcaption>
</figure>

<figure>
    <img src="https://raw.githubusercontent.com/jaljo/articles/master/images/fe_3.png" alt="cinematic-3" />
    <figcaption>
        The panel can be closed from multiple origins.
    </figcaption>
</figure>

<figure>
    <img src="https://raw.githubusercontent.com/jaljo/articles/master/images/fe_4.png" alt="cinematic-4" />
    <figcaption>
        The panel closes gently, although a bit sad.
    </figcaption>
</figure>

<p>
    We ended up with two panels being part of the content editor interface,
    where editors can edit metadata. As you can see in the third screen, each
    panel can be closed from multiple events :
</p>

<ul>
    <li>
        by clicking on the same button that triggered the panel opening,
    </li>
    <li>
        by clicking on the save button inside the open panel,
    </li>
    <li>
        by opening another panel (it makes sense that there can only be one
        panel opened at a time).
    </li>
</ul>

<p>
    Therefore, we have to submit the form data of the panel we’re closing,
    regardless where we’re closing it from. Luckily enough, we’re using React
    along with Redux, so it shouldn’t be such a big deal to solve this. A
    traditionnal flow would be something like :
</p>

<ul>
    <li>
        all three events dispatch a generic <span class="code">CLOSE</span>
        action,
    </li>
    <li>
        this action reduces the state of the panel, say it sets a boolean to
        <span class="code">false</span>,
    </li>
    <li>
        this boolean is used in a React component to mount or unmount the panel,
    </li>
    <li>
        using lifecycle hooks, we can dispatch a
        <span class="code">SUBMIT</span> action when the component is about
        to unmount. This action gathers and carries the form data in its
        payload, so we can do whatever we want with it later in our program.
    </li>
</ul>

<figure>
    <img src="https://raw.githubusercontent.com/jaljo/articles/master/images/sigourney_small.jpg" alt="good-ol-sigourney" />
    <figcaption>
        Sounds great, doesn’t it? Sigourney Weaver approves.
    </figcaption>
</figure>

<p>
    What we have forgotten is, our lovely designer friend thought of beautiful
    animations for the panel to play whenever it’s opening or closing, and bam !
    The above flow no longer works. Because we need to unmount the panel
    component to submit the form data, it will not always been present in the
    DOM, and so playing animation with it becomes much more complicated.
</p>

<p>
    The key idea here is <i>time</i>. We have to think of intermediate actions
    that will let us identify the moment when the panel is opening or closing,
    so we can delay the moment it will be unmounted.
</p>

<p>
    Schematically, here is the flow we’re aiming to achieve :
</p>

<ul>
    <li>
        a user clicks on an element to open the panel. It dispatches an
        <span class="code">OPEN</span> action,
    </li>
    <li>
        based on its state, the panel can be mounted in the DOM,
    </li>
    <li>
        a lifecycle hook dispatches a <span class="code">MOUNTED</span>
        action,
    </li>
    <li>
        the state is updated, we can dynamically append a CSS class to the panel
        view component, the sliding animation can be played.
    </li>
</ul>

<p>
    The same logic applies when closing the panel, with a subtlety however:
</p>

<ul>
    <li>
        a user clicks on one of the three elements that fire the
        <span class="code">CLOSE</span> action,
    </li>
    <li>
        the state updates, the CSS class is removed from the view, the panel
        gently returns to its initial position,
    </li>
    <li>
        <i>here is the magic trick</i> : we need to dispatch a
        <span class="code">CLOSED</span> action, so the panel can be
        unmounted, but <i>after</i> the animation is complete. This is where
        epics come into play ! The <span class="code">CLOSE</span> action is
        observed by a little epic, which <i>delays</i> this action, just the
        time we need to play the closing animation. Then, it finally dispatches
        the <span class="code">CLOSED</span> action,
    </li>
    <li>
        from there, we can take back our initial flow : the state is updated and
        the panel (which is now hidden, thanks to epics) is unmounted,
    </li>
    <li>
        a lifecycle hook triggers the <span class="code">SUBMIT</span>
        action when the panel is unmounted.
    </li>
</ul>

<p>
    And voila ! Just to make things clearer, below are some examples of what
    such implementation may look like. Here is an extract of the container
    component of a panel, with its lifecycle hooks :
</p>

<div class="git-gist" data-src="https://gist.github.com/jaljo/6a79a307887da60a99e860711f907b0b.js"></div>

<p>
    Here is the panel view component. Just notice how we use the
    <span class="code">isOpening</span> prop to set the opening CSS class in
    the section tag.
</p>

<div class="git-gist" data-src="https://gist.github.com/jaljo/e060d7b1b63147a049399111f5462ab2.js"></div>

<p>
    The reducer takes care of updating the panel state. We’re using two distinct
    booleans : one to determine whether the component should be mounted or not,
    the other to identify if we are playing the animation.
</p>

<div class="git-gist" data-src="https://gist.github.com/jaljo/9eb3a0d6ee31be64161041db190a39c6.js"></div>

<p>
    And the icing on the cake, a little epic that delays our
    <span class="code">CLOSED</span> action :
</p>

<div class="git-gist" data-src="https://gist.github.com/jaljo/9eb3a0d6ee31be64161041db190a39c6.js"></div>

<p>
    I published a proof of concept repository with the entire source code
    <a href="https://github.com/jaljo/form-events">here</a>. Check it out !
</p>
